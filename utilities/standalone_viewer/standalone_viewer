# stack_viewer.py
import os
import pygame
from typing import List, Tuple

# =======================
# CONFIG — edit this path
# =======================
BASE_DIR = os.path.dirname(__file__)
FOLDER   = os.path.join(BASE_DIR, "sprite_stack_images")
SCREEN_W, SCREEN_H = 256, 256
FPS_TARGET = 120

# View defaults
INIT_SCALE       = 1     # integer magnification (pixel-perfect)
SCALE_MIN        = 1
SCALE_MAX        = 128
SPACING_BASE_INIT= 0.5    # base px per layer (gets multiplied by scale)
ANGLE_SPEED      = 180.0  # deg/sec when key held
SHOW_HELP        = False
SPACING_FACTOR = 0.10

# =======================
# Helpers
# =======================
IMG_EXTS = {".png", ".bmp", ".jpg", ".jpeg", ".webp", ".tga"}

def list_image_files(folder: str) -> List[str]:
    files: List[str] = []
    for root, _dirs, fnames in os.walk(folder):
        for f in sorted(fnames):
            if os.path.splitext(f.lower())[1] in IMG_EXTS:
                files.append(os.path.join(root, f))
    if not files:
        raise SystemExit(f"No image files found under: {folder}")
    return files

def load_image(path: str) -> pygame.Surface:
    try:
        return pygame.image.load(path).convert_alpha()
    except Exception as e:
        raise SystemExit(f"Failed to load image '{path}': {e}")

def infer_slice_len(sheet: pygame.Surface) -> Tuple[int, str, int]:
    w, h = sheet.get_width(), sheet.get_height()
    if w >= h and w % h == 0:
        return h, "horizontal", w // h
    if h > w and h % w == 0:
        return w, "vertical", h // w
    sl = min(w, h)
    if w // sl >= 2:
        return sl, "horizontal", w // sl
    if h // sl >= 2:
        return sl, "vertical", h // sl
    return sl, "horizontal", 1

def slice_strip(sheet: pygame.Surface) -> List[pygame.Surface]:
    sl, layout, count = infer_slice_len(sheet)
    slices: List[pygame.Surface] = []
    if layout == "horizontal":
        for i in range(count):
            rect = pygame.Rect(i * sl, 0, sl, sl)
            slices.append(sheet.subsurface(rect).copy())
    else:
        for i in range(count):
            rect = pygame.Rect(0, i * sl, sl, sl)
            slices.append(sheet.subsurface(rect).copy())
    return slices

def blit_center(screen: pygame.Surface, surf: pygame.Surface, pos):
    r = surf.get_rect(center=pos)
    screen.blit(surf, r)

# =======================
# Main App
# =======================
def main():
    pygame.init()
    pygame.display.set_caption("Sprite-Stack Viewer")
    screen = pygame.display.set_mode((SCREEN_W, SCREEN_H))
    clock  = pygame.time.Clock()
    font   = pygame.font.SysFont(None, 22)

    if not os.path.isdir(FOLDER):
        raise SystemExit(f"Not a folder: {FOLDER}")

    files = list_image_files(FOLDER)
    print(f"Found {len(files)} images under: {FOLDER}")
    idx = 0

    # View state
    angle        = 0.0
    scale_ix     = INIT_SCALE         # integer scale (pixel-perfect)
    spacing_base = SPACING_BASE_INIT  # base spacing; effective spacing = base * scale
    show_help    = SHOW_HELP

    BASE_Y_BIAS = 80  # nudge down so the stack grows upward

    def load_current():
        path = files[idx]
        sheet = load_image(path)
        slices = slice_strip(sheet)
        return path, slices

    current_path, current_slices = load_current()

    running = True
    while running:
        dt = clock.get_time() / 1000.0  # seconds since last frame

        for e in pygame.event.get():
            if e.type == pygame.QUIT:
                running = False
            elif e.type == pygame.KEYDOWN:
                k = e.key
                if k == pygame.K_ESCAPE:
                    running = False

                # base spacing (independent control; effective = base * scale)
                elif k in (pygame.K_w, pygame.K_UP):
                    spacing_base += SPACING_FACTOR
                elif k in (pygame.K_s, pygame.K_DOWN):
                    spacing_base = max(0.0, spacing_base - SPACING_FACTOR)

                # integer scale (pixel-perfect)
                elif k in (pygame.K_EQUALS, pygame.K_PLUS):
                    scale_ix = min(SCALE_MAX, scale_ix + 1)
                elif k in (pygame.K_MINUS, pygame.K_UNDERSCORE):
                    scale_ix = max(SCALE_MIN, scale_ix - 1)

                # reset
                elif k == pygame.K_0:
                    angle        = 0.0
                    scale_ix     = INIT_SCALE
                    spacing_base = SPACING_BASE_INIT

                # cycle files
                elif k == pygame.K_SPACE:
                    idx = (idx + 1) % len(files)
                    current_path, current_slices = load_current()
                elif k == pygame.K_BACKSPACE:
                    idx = (idx - 1) % len(files)
                    current_path, current_slices = load_current()

                # toggle help
                elif k == pygame.K_h:
                    show_help = not show_help

        # continuous rotation while held
        keys = pygame.key.get_pressed()
        if keys[pygame.K_a] or keys[pygame.K_LEFT]:
            angle -= ANGLE_SPEED * dt
        if keys[pygame.K_d] or keys[pygame.K_RIGHT]:
            angle += ANGLE_SPEED * dt

        # Draw
        screen.fill((18, 20, 24))
        cx, cy = SCREEN_W // 2, SCREEN_H // 2 + BASE_Y_BIAS

        effective_spacing = spacing_base * scale_ix

        if current_slices:
            for i, layer in enumerate(current_slices):
                surf = layer
                if scale_ix != 1:
                    w, h = surf.get_size()
                    surf = pygame.transform.scale(surf, (w * scale_ix, h * scale_ix))
                if angle % 360 != 0:
                    surf = pygame.transform.rotate(surf, angle)
                blit_center(screen, surf, (cx, cy - int(i * effective_spacing)))

        # HUD
        info = [
            f"[{idx+1}/{len(files)}] {os.path.basename(current_path)}",
            f"Angle: {angle:6.1f}°  (hold A/← or D/→)",
            f"Scale: {scale_ix}×  (+ / - , 0=reset)",
            f"Spacing base: {spacing_base:.1f} px | Effective: {effective_spacing:.1f} px/layer  (W/↑, S/↓)",
            "Next: Space | Prev: Backspace | Help: H | Quit: Esc",
        ]
        for n, line in enumerate(info):
            img = font.render(line, True, (220, 220, 220))
            screen.blit(img, (10, 10 + n*22))

        if show_help:
            help_lines = [
                "Sheets can be a horizontal OR vertical strip of square slices.",
                "Integer scaling keeps pixels crisp; spacing auto-multiplies by scale.",
                "Rotation is continuous while keys are held.",
            ]
            y = SCREEN_H - (len(help_lines)*22) - 10
            for line in help_lines:
                img = font.render(line, True, (170, 200, 255))
                screen.blit(img, (10, y))
                y += 22

        pygame.display.flip()
        clock.tick(FPS_TARGET)

    pygame.quit()

if __name__ == "__main__":
    main()
